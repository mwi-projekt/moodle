define(["jquery","core/ajax","core/notification","core/str"],function(r,o,t,i){let n=null,s=null,l=null,c={};let d=()=>({Streets:l.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19,noWrap:!1}),Satellite:l.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:'&copy; <a href="https://www.esri.com/">Esri</a>, Maxar, Earthstar Geographics',maxZoom:18,noWrap:!1}),"CartoDB Light":l.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',maxZoom:19,noWrap:!1}),"CartoDB Dark":l.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',maxZoom:19,noWrap:!1})}),p=()=>{let a=0;n.on("layeradd",e=>{e.layer._url&&(e.layer.on("loading",()=>{a++,r("#university-map").addClass("tiles-loading")}),e.layer.on("load",()=>{--a<=0&&r("#university-map").removeClass("tiles-loading")}))})},m=e=>{var a=r("#university-map");let o=a.find(".loading-overlay");e?(a.addClass("loading"),o.show()):(a.removeClass("loading"),setTimeout(()=>{o.fadeOut(300)},500))},u=(e,a)=>{var o={success:"alert-success",warning:"alert-warning",error:"alert-danger",info:"alert-info"}[e]||"alert-info",t={success:"fa-check-circle",warning:"fa-exclamation-triangle",error:"fa-exclamation-circle",info:"fa-info-circle"}[e]||"fa-info-circle",o=(0===r("#map-status-messages").length&&r("#university-map-container").prepend('<div id="map-status-messages"></div>'),`
            <div class="alert ${o} alert-dismissible fade show" role="alert">
                <i class="fa ${t}" aria-hidden="true"></i>
                ${a}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);r("#map-status-messages").html(o),"success"!==e&&"info"!==e||setTimeout(()=>{r("#map-status-messages .alert").fadeOut(500)},5e3)},g=e=>{console.log("Adding universities to map"),s.clearLayers();let o={},t=[];e.forEach(e=>{var a;e.latitude&&e.longitude&&(a=y(e),s.addLayer(a),t.push(a),o[e.country]||(o[e.country]=[]),o[e.country].push(a))}),a(t),0<t.length&&f(t),w(e.length)},y=e=>{var a=v(e),a=l.marker([e.latitude,e.longitude],{icon:a,title:e.name}).bindPopup(b(e),{maxWidth:300,className:"university-popup-container"});return a.on("mouseover",function(){this.openPopup()}),a.universityData=e,a},v=e=>{let a="#dc3545";return 0<e.available_slots&&(a=5<e.available_slots?"#28a745":"#ffc107"),l.divIcon({className:"university-marker",html:`
                <div class="marker-pin" style="background-color: ${a};">
                    <i class="fa fa-university" style="color: white; font-size: 12px;"></i>
                </div>
                <div class="marker-pulse" style="background-color: ${a};"></div>
            `,iconSize:[30,42],iconAnchor:[15,42],popupAnchor:[0,-42]})},a=e=>{n.on("worldcopyjump",()=>{e.forEach(e=>{var a=e.getLatLng();e.setLatLng([a.lat,a.lng])})}),n.on("zoomend moveend",()=>{h(e)})},h=e=>{let o=n.getBounds();n.getZoom();e.forEach(e=>{var a=e.getLatLng();o.contains(a)&&!s.hasLayer(e)&&s.addLayer(e)})},f=e=>{try{var a=l.featureGroup(e).getBounds();n.fitBounds(a,{padding:[20,20],maxZoom:10}),1===e.length&&n.setZoom(6)}catch(e){console.error("Error fitting bounds:",e),n.setView([30,10],2)}},w=e=>{var a=r("#university-counter");a.length&&a.text(e),0<e&&(document.title=e+" Universities - International Office")},b=e=>{let a='<div class="university-popup">';return a=(a+=`<h4>${e.name}</h4>`)+`<p><strong>${e.city}, ${e.country}</strong></p>`,e.available_slots&&(a+=`<p>${c.availableSlots}: ${e.available_slots}</p>`),e.reports_count&&(a+=`<p>${c.reports}: ${e.reports_count}</p>`),a=a+`<a href="${e.detail_url}" class="btn btn-primary btn-sm mt-2">${c.viewDetails}</a>`+"</div>"},_=()=>{r(".dhbwio-view-switcher a").on("click",e=>{e.preventDefault();var e=r(e.currentTarget),a=e.attr("href").split("view=")[1];r(".dhbwio-view-switcher a").removeClass("active btn-primary").addClass("btn-secondary"),e.removeClass("btn-secondary").addClass("active btn-primary"),"map"===a?(r("#university-list").hide(),r("#university-map-container").show(),n&&n.invalidateSize()):(r("#university-map-container").hide(),r("#university-list").show())})};return{init:async e=>{let a=e;await(async()=>{try{var e=await i.get_strings([{key:"university_available_slots",component:"mod_dhbwio"},{key:"reports",component:"mod_dhbwio"},{key:"view_details",component:"mod_dhbwio"},{key:"loading_universities",component:"mod_dhbwio"},{key:"map_loading_error",component:"mod_dhbwio"},{key:"leaflet_not_loaded",component:"mod_dhbwio"},{key:"map_creation_error",component:"mod_dhbwio"}]);c={availableSlots:e[0],reports:e[1],viewDetails:e[2],loadingUniversities:e[3],mapLoadingError:e[4],leafletNotLoaded:e[5],mapCreationError:e[6]}}catch(e){c={availableSlots:"Available Slots",reports:"Reports",viewDetails:"View Details",loadingUniversities:"Loading universities...",mapLoadingError:"Error loading universities",leafletNotLoaded:"Leaflet library not loaded",mapCreationError:"Error creating map"},console.warn("Could not load language strings, using fallback:",e)}})(),r(document).ready(()=>{r("#university-map").length?(console.log("Map container found, initializing map for CM ID:",a),(()=>{if(console.log("initMap called"),typeof L==="undefined")if(typeof window.L!=="undefined"){l=window.L;console.log("Found Leaflet as window.L")}else{console.error("Leaflet library not loaded");t.exception({message:c.leafletNotLoaded});return}else{l=L;console.log("Leaflet already available as L")}try{console.log("Creating map");const e=l.latLngBounds(l.latLng(-85,-180),l.latLng(85,180));n=l.map("university-map",{center:[30,10],zoom:2,minZoom:1,maxZoom:18,maxBounds:e,maxBoundsViscosity:.8,worldCopyJump:true,zoomControl:false});l.control.zoom({position:"topright"}).addTo(n);const a=d();a["Streets"].addTo(n);const o=l.control.layers(a,null,{position:"topleft",collapsed:false}).addTo(n);console.log("Map created, adding marker layer");s=l.layerGroup().addTo(n);_();l.control.scale({position:"bottomright",metric:true,imperial:false}).addTo(n);p()}catch(e){console.error("Error creating map:",e);t.exception({message:`${c.mapCreationError}: ${e.message}`})}})(),n&&(async e=>{console.log("Loading universities data"),m(true);try{const a=await o.call([{methodname:"mod_dhbwio_get_universities",args:{cmid:e}}])[0];console.log("Universities data loaded:",a);if(a&&a.universities){g(a.universities);u("success",`${a.universities.length} universities loaded successfully`)}else u("warning","No universities found")}catch(e){console.error("Error loading universities:",e);u("error",c.mapLoadingError);t.exception({message:c.mapLoadingError,error:e})}finally{m(false)}})(a)):console.error("Map container not found")})}}});
//# sourceMappingURL=university_map.min.js.map